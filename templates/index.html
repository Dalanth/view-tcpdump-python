<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>TCPDUMP</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <style>
      .pagination-page-info {
          padding: .6em;
          padding-left: 0;
          width: 40em;
          margin: .5em;
          margin-left: 0;
          font-size: 12px;
      }
      .pagination-page-info b {
          color: black;
          background: #6aa6ed;
          padding-left: 2px;
          padding: .1em .25em;
          font-size: 150%;
      }
      #message {
        position: absolute;
        margin:auto;
        top: 15px;
        left: 15%;
        right: 15%;
      }
    </style>
  </head>
  <body>
    <div id="message"></div>
    <div class="container-fluid">
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <!-- Collect the nav links, forms, and other content for toggling -->
          <ul class="nav navbar-nav">
            <li><a href="{{ url_for('index') }}" class=""><span class="glyphicon glyphicon-refresh"></span></a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li>
              <a href="#home" class="" aria-controls="home" role="tab" data-toggle="tab">
                Inicio
              </a>
            </li>
            <li>
              <a href="#estadistica" class="" aria-controls="estadistica" role="tab" data-toggle="tab">
                Estadísticas
              </a>
            </li>
            <li>
              <a href="{{ url_for('remove') }}" class="">
                Eliminar información
              </a>
            </li>
          </ul>
      </div><!-- /.container-fluid -->
    </nav>
    <div class="tab-content">
      <div role="tabpanel" class="tab-pane fade in active" id="home">
        {% if total > 1 %}
            {{ pagination.info }}
        {% endif %}
        {{ pagination.links }}
        <table id="main-table" class="table table-striped">
          <tr>
            <th>Fecha - Hora</th>
            <th>Origen</th>
            <th>Puerto</th>
            <th>Destino</th>
            <th>Puerto</th>
          </tr>
          {% for post in posts %}
          <tr>
            <td>{{ post.package.date }}</td>
            <td>{{ post.package.source }}</td>
            <td>{{ post.package.source_port }}</td>
            <td>{{ post.package.destiny }}</td>
            <td>{{ post.package.destiny_port }}</td>
          </tr>
          {% endfor %}
        </table>
      </div>
      <div role="tabpanel" class="tab-pane fade" id="estadistica">
        <table id="stat-table" class="table table-striped">
          <tr>
            <th>Puerto (protocolo)</th>
            <th>Total de paquetes</th>
          </tr>
          {% for q in quantity %}
          <tr>
            <td>{{ q.source_port }}</td>
            <td>{{ q.count }}</td>
          </tr>
          {% endfor %}
        </table>
      </div>
    </div>
    </div>
    <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script>
    <script>
        var latest = document.getElementById('latest');
        var output = document.getElementById('main-table');

        var xhr = new XMLHttpRequest();
        xhr.open('GET', '{{ url_for('stream') }}');
        xhr.send();
        var position = 0;

        function handleNewData() {
            // the response text include the entire response so far
            // split the messages, then take the messages that haven't been handled yet
            // position tracks how many messages have been handled
            // messages end with a newline, so split will always show one extra empty message at the end
            var messages = xhr.responseText.split('\n');
            messages.slice(position, -1).forEach(function(value) {
                latest.textContent = value;  // update the latest value in place
                // build and append a new item to a list to log all output
                var item = document.createElement('tr');
                item.textContent = value;
                output.appendChild(item);
            });
            position = messages.length - 1;
        }

        var timer;
        timer = setInterval(function() {
            // check the response for new data
            handleNewData();
            // stop checking once the response has ended
            if (xhr.readyState == XMLHttpRequest.DONE) {
                clearInterval(timer);
                latest.textContent = 'Done';
            }
        }, 1000);
    </script>
  </body>
</html>
